# Preference Evolution

## Context
- `docs/02-product-preferences.md` introduced automatic preference capture plus a chat queue, but day-to-day use showed we rarely want implicit updates or category variants.
- We (the two in-house users) are comfortable editing YAML directly and prefer deterministic behavior over automatic inference.
- Goal: keep normalization and human-in-the-loop queueing, but reduce stored state to “one explicit favorite per category” with clear override rules.

## Core Rules
- A category can hold at most one favorite product.
- Favorites are opt-in: the shopper must explicitly nominate the product during selection.
- Any shopping-list entry that specifies a brand (or other qualifier flagged by the parser as “specific”) bypasses the stored favorite.
- Items can still be added without a favorite; they simply prompt for a decision via the existing queue.

## Parsing Expectations
- Normalization still runs on every shopping-list item.
- Extract three fields: category, brand, quantity.
- Category must exclude size descriptors (“1L”, “dozen”) and qualifiers (“1%”, “organic”) to keep canonical keys stable. Qualifiers can surface as free-form hints for the agent prompt.
- If the parser detects a brand (non-empty string), the item counts as “specific”. Other qualifiers (`for baking`, `gluten free`) should be emitted as descriptive text so the agent can include them when searching, but they do not change the canonical key unless we decide to treat them as hint-derived subcategories later.
- Quantity remains the number of units being ordered; “Milk x3” should still map to the same category key as “Milk”.

## Interaction Flow
1. **Normalize** the raw list entry.
2. **Look up** the category key in the YAML store.
3. **If a favorite exists and the request is not specific**, hand that product to the browser agent. The agent proceeds straight to checkout steps.
4. **If no favorite exists, or the request is specific**, the agent searches metro.ca and either succeeds autonomously or triggers the preference queue for help.
5. **During a queued decision**, the prompt includes a “Make this my default” toggle. Selecting it records the favorite; otherwise the preference store remains unchanged.
6. **Review** happens on metro.ca’s cart page (manual) plus our Home Assistant notification. We can annotate default-based fills in that notification copy.

## Queueing & Prompt Surface
- Single outstanding request is still enforced; Telegram messenger keeps its sequential flow.
- Buttons include: numbered options, Skip, “Star this choice” (default toggle).
- Alternate free-text replies continue to re-run normalization and restart the flow under the original canonical key.
- Reminder cadence (30 minutes) and nag strings stay as-is.

## Review & Instrumentation
- Metro.ca remains the primary review UI; no per-item signaling available.
- We can use the Home Assistant persistent notification and/or CLI logs to mark items that were filled via stored favorites versus explicit list text.
- Observability focus: log when normalization changes the canonical key, when a favorite override fires, and any time the shopper toggles a favorite on/off.

## Implementation Notes & To-Dos (grounded in current code)
- **Normalize without qualifiers** – Adjust `SYSTEM_PROMPT` and post-processing to strip “1%”, “organic”, etc. from `category` while preserving them as hints; see `src/gemini_supply/preferences/normalizer.py:21-77`.
- **Flag specific requests** – Treat a populated `brand` (or other qualifier flag) as the signal to bypass favorites during `_process_item`; currently every normalized item retrieves `existing_preference` unconditionally (`src/gemini_supply/shopping/orchestrator.py:396-436`).
- **Opt-in persistence** – `PreferenceItemSession.record_success` automatically writes every success (`src/gemini_supply/preferences/service.py:104-128`). Gate this behind the default toggle (probably a bool returned from the queue result).
- **Messenger payload** – Extend `ProductChoiceResult` and Telegram handlers to carry the “make default” flag (`src/gemini_supply/preferences/types.py:52-86`, `src/gemini_supply/preferences/messenger.py:1-340`).
- **Queue prompt copy** – Include the new toggle in the inline keyboard and acknowledgement messages (`messenger.py` handlers).
- **Notification context** – Tag default-filled items in the summary generated by `HomeAssistantShoppingListProvider.send_summary` so the persistent notification can mention defaults (`src/gemini_supply/grocery/home_assistant_shopping_list.py:60-132`).
- **Testing** – Add coverage around the new branching behavior (default bypass, opt-in favorite recording) in `tests/test_shopping_orchestrator.py` once the logic lands.

## Open Questions
- Do we want to treat phrases like “Milk for baking” as hint-triggered subcategories, or keep them as free text? We can decide after observing a few runs.
- Should clearing a favorite require YAML edits only, or do we expose a CLI helper later?
- Where should we persist statistics (e.g., number of items resolved via default) for future tuning?
